name: Generate CLI Recording (Prod)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  record:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────────────────────
      # Setup
      # ─────────────────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Phantom-WG
        run: |
          chmod +x phantom-install.sh
          sudo ./phantom-install.sh

      - name: Verify Phantom-WG Installation
        run: |
          if [ ! -d "/opt/phantom-wg" ] || [ ! -f "/opt/phantom-wg/.phantom-venv/bin/python" ]; then
            echo "Error: Phantom-WG installation failed"
            exit 1
          fi
          echo "Phantom-WG installation verified"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y asciinema expect

      # ─────────────────────────────────────────────────────────────
      # Generate Recording
      # ─────────────────────────────────────────────────────────────
      - name: Record Interactive CLI
        env:
          TERM: xterm-256color
        run: |
          cd documentation/tools/scripts/recording_automations_api
          mkdir -p recordings/cli
          chmod +x cli/interactive_cli.exp

          asciinema rec \
            --cols 120 \
            --rows 48 \
            --idle-time-limit 2 \
            -t "interactive_cli" \
            -c "expect cli/interactive_cli.exp" \
            recordings/cli/interactive_cli.cast

      # ─────────────────────────────────────────────────────────────
      # Copy and Commit Recording
      # ─────────────────────────────────────────────────────────────
      - name: Prepare Recording for Commit
        run: |
          SOURCE="documentation/tools/scripts/recording_automations_api/recordings/cli/interactive_cli.cast"
          TARGET="documentation/docs/assets/static/recordings/feature-showcase/interactive_cli"

          cp "$SOURCE" "$TARGET"
          echo "Copied: interactive_cli"

      - name: Commit and Push Recording
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add documentation/docs/assets/static/recordings/feature-showcase/interactive_cli

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update interactive CLI recording"
            git push
            echo "Recording committed and pushed"
          fi
