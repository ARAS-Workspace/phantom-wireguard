name: Generate CLI Recording (Dev)

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  RECORDER_DIR: documentation/tools/scripts/phantom-recorder
  AGG_IMAGE: ghcr.io/asciinema/agg:latest

jobs:
  record:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────────────────────
      # Setup
      # ─────────────────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Phantom-WG
        run: |
          chmod +x phantom-install.sh
          sudo ./phantom-install.sh

      - name: Verify Phantom-WG Installation
        run: |
          if [ ! -d "/opt/phantom-wg" ] || [ ! -f "/opt/phantom-wg/.phantom-venv/bin/python" ]; then
            echo "Error: Phantom-WG installation failed"
            exit 1
          fi
          echo "Phantom-WG installation verified"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y asciinema
          pip install -r ${{ env.RECORDER_DIR }}/requirements.txt

      # ─────────────────────────────────────────────────────────────
      # Pull agg Docker Image
      # ─────────────────────────────────────────────────────────────
      - name: Pull agg Docker Image
        run: docker pull ${{ env.AGG_IMAGE }}

      # ─────────────────────────────────────────────────────────────
      # Generate Recordings
      # ─────────────────────────────────────────────────────────────
      - name: Record Interactive CLI
        working-directory: ${{ env.RECORDER_DIR }}
        env:
          TERM: xterm-256color
        run: |
          python3 phantom_recorder.py workflows/interactive-cli.yaml

      # ─────────────────────────────────────────────────────────────
      # Convert .cast to .gif
      # ─────────────────────────────────────────────────────────────
      - name: Convert Recordings to GIF
        working-directory: ${{ env.RECORDER_DIR }}
        run: |
          echo "Converting .cast files to .gif..."

          for cast_file in recordings/*.cast; do
            [ -f "$cast_file" ] || continue

            filename=$(basename "$cast_file" .cast)
            gif_file="recordings/${filename}.gif"

            echo "  Converting: $filename.cast → $filename.gif"

            docker run --rm \
              -v "$(pwd)/recordings:/data" \
              ${{ env.AGG_IMAGE }} \
              "/data/${filename}.cast" \
              "/data/${filename}.gif" \
              --font-size 14 \
              --cols 120 \
              --rows 48
          done

          echo ""
          echo "Conversion complete. Files:"
          ls -la recordings/

      # ─────────────────────────────────────────────────────────────
      # Upload Artifacts
      # ─────────────────────────────────────────────────────────────
      - name: Upload Recordings Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-recording-${{ github.run_id }}
          path: |
            ${{ env.RECORDER_DIR }}/recordings/*.cast
            ${{ env.RECORDER_DIR }}/recordings/*.gif
          retention-days: 90
