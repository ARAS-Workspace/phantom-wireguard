name: Generate CLI Recording (Dev)

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  RECORDINGS_DIR: documentation/tools/scripts/recording_automations_api/recordings/cli
  AGG_IMAGE: ghcr.io/asciinema/agg:latest

jobs:
  record:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────────────────────
      # Setup
      # ─────────────────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Phantom-WG
        run: |
          chmod +x phantom-install.sh
          sudo ./phantom-install.sh

      - name: Verify Phantom-WG Installation
        run: |
          if [ ! -d "/opt/phantom-wg" ] || [ ! -f "/opt/phantom-wg/.phantom-venv/bin/python" ]; then
            echo "Error: Phantom-WG installation failed"
            exit 1
          fi
          echo "Phantom-WG installation verified"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y asciinema expect

      # ─────────────────────────────────────────────────────────────
      # Pull agg Docker Image
      # ─────────────────────────────────────────────────────────────
      - name: Pull agg Docker Image
        run: docker pull ${{ env.AGG_IMAGE }}

      # ─────────────────────────────────────────────────────────────
      # Generate Recording
      # ─────────────────────────────────────────────────────────────
      - name: Record Interactive CLI
        env:
          TERM: xterm-256color
        run: |
          cd documentation/tools/scripts/recording_automations_api
          mkdir -p recordings/cli
          chmod +x cli/interactive_cli.exp

          asciinema rec \
            --cols 120 \
            --rows 48 \
            --idle-time-limit 2 \
            -t "interactive_cli" \
            -c "expect cli/interactive_cli.exp" \
            recordings/cli/interactive_cli.cast

      # ─────────────────────────────────────────────────────────────
      # Convert .cast to .gif
      # ─────────────────────────────────────────────────────────────
      - name: Convert Recording to GIF
        run: |
          echo "Converting .cast to .gif..."

          docker run --rm \
            -v "$(pwd)/${{ env.RECORDINGS_DIR }}:/data" \
            ${{ env.AGG_IMAGE }} \
            "/data/interactive_cli.cast" \
            "/data/interactive_cli.gif" \
            --font-size 14 \
            --cols 120 \
            --rows 48

          echo ""
          echo "Conversion complete. Files:"
          ls -la ${{ env.RECORDINGS_DIR }}/

      # ─────────────────────────────────────────────────────────────
      # Upload Artifacts
      # ─────────────────────────────────────────────────────────────
      - name: Upload Recordings Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-recording-${{ github.run_id }}
          path: |
            ${{ env.RECORDINGS_DIR }}/*.cast
            ${{ env.RECORDINGS_DIR }}/*.gif
          retention-days: 90
