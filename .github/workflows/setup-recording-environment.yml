name: Setup Recording Environment

on:
  workflow_dispatch:
    inputs:
      session_name:
        description: 'Session name (e.g., ghost-recording, multihop-test)'
        required: true
        type: string
        default: 'recording-session'

env:
  DO_REGION: fra1
  DO_SIZE: s-2vcpu-4gb
  VPC_SUBNET: "10.10.0.0/16"
  # Snapshot IDs (fixed)
  SNAPSHOT_MASTER: "216070980"
  SNAPSHOT_SERVER: "216070984"
  SNAPSHOT_CLIENT: "216070988"
  SNAPSHOT_EXIT: "216070991"

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Generate Session ID
        id: session
        run: |
          TIMESTAMP=$(date +%s)
          SESSION_ID="phantom-${{ inputs.session_name }}-${TIMESTAMP}"
          echo "SESSION_ID=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "Session ID: $SESSION_ID"

      # ─────────────────────────────────────────────────────────────
      # Create Project
      # ─────────────────────────────────────────────────────────────
      - name: Create Project
        id: project
        run: |
          SESSION_ID="${{ steps.session.outputs.SESSION_ID }}"

          PROJECT_JSON=$(doctl projects create \
            --name "$SESSION_ID" \
            --purpose "Recording session" \
            --environment "Development" \
            --output json)

          PROJECT_ID=$(echo "$PROJECT_JSON" | jq -r '.[0].id')

          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "Created project: $SESSION_ID ($PROJECT_ID)"

      # ─────────────────────────────────────────────────────────────
      # Create VPC
      # ─────────────────────────────────────────────────────────────
      - name: Create VPC
        id: vpc
        run: |
          SESSION_ID="${{ steps.session.outputs.SESSION_ID }}"

          echo "Creating VPC: ${SESSION_ID}-vpc"
          echo "Region: ${{ env.DO_REGION }}"
          echo "IP Range: ${{ env.VPC_SUBNET }}"

          VPC_JSON=$(doctl vpcs create \
            --name "${SESSION_ID}-vpc" \
            --region ${{ env.DO_REGION }} \
            --ip-range ${{ env.VPC_SUBNET }} \
            --output json 2>&1) || {
            echo "VPC creation failed:"
            echo "$VPC_JSON"
            exit 1
          }

          echo "VPC Response: $VPC_JSON"

          VPC_ID=$(echo "$VPC_JSON" | jq -r '.[0].id // .id // empty')

          if [ -z "$VPC_ID" ]; then
            echo "Failed to parse VPC ID from response"
            exit 1
          fi

          echo "VPC_ID=$VPC_ID" >> $GITHUB_OUTPUT
          echo "Created VPC: ${SESSION_ID}-vpc ($VPC_ID)"

      # ─────────────────────────────────────────────────────────────
      # Create Droplets
      # ─────────────────────────────────────────────────────────────
      - name: Create Droplets
        id: droplets
        run: |
          VPC_ID="${{ steps.vpc.outputs.VPC_ID }}"
          SESSION_ID="${{ steps.session.outputs.SESSION_ID }}"

          echo "Creating droplets in VPC: $VPC_ID"
          echo ""

          create_droplet() {
            local name=$1
            local image=$2
            local var_name=$3

            echo "Creating $name with image $image..."

            RESULT=$(doctl compute droplet create "${SESSION_ID}-${name}" \
              --image "$image" \
              --size ${{ env.DO_SIZE }} \
              --region ${{ env.DO_REGION }} \
              --vpc-uuid "$VPC_ID" \
              --wait \
              --output json 2>&1) || {
              echo "Failed to create $name:"
              echo "$RESULT"
              return 1
            }

            ID=$(echo "$RESULT" | jq -r '.[0].id // empty')
            if [ -z "$ID" ]; then
              echo "Failed to parse ID for $name"
              echo "Response: $RESULT"
              return 1
            fi

            echo "${var_name}=$ID" >> $GITHUB_OUTPUT
            echo "Created: $name ($ID)"
          }

          create_droplet "master" "${{ env.SNAPSHOT_MASTER }}" "MASTER_ID"
          create_droplet "server" "${{ env.SNAPSHOT_SERVER }}" "SERVER_ID"
          create_droplet "client" "${{ env.SNAPSHOT_CLIENT }}" "CLIENT_ID"
          create_droplet "exit" "${{ env.SNAPSHOT_EXIT }}" "EXIT_ID"

      # ─────────────────────────────────────────────────────────────
      # Assign Resources to Project
      # ─────────────────────────────────────────────────────────────
      - name: Assign Resources to Project
        run: |
          PROJECT_ID="${{ steps.project.outputs.PROJECT_ID }}"

          doctl projects resources assign $PROJECT_ID \
            --resource=do:droplet:${{ steps.droplets.outputs.MASTER_ID }} \
            --resource=do:droplet:${{ steps.droplets.outputs.SERVER_ID }} \
            --resource=do:droplet:${{ steps.droplets.outputs.CLIENT_ID }} \
            --resource=do:droplet:${{ steps.droplets.outputs.EXIT_ID }}

          echo "All droplets assigned to project"

      # ─────────────────────────────────────────────────────────────
      # Display Results
      # ─────────────────────────────────────────────────────────────
      - name: Display Environment Info
        run: |
          SESSION_ID="${{ steps.session.outputs.SESSION_ID }}"

          # Get private IPs
          MASTER_INFO=$(doctl compute droplet get ${{ steps.droplets.outputs.MASTER_ID }} --output json)
          SERVER_INFO=$(doctl compute droplet get ${{ steps.droplets.outputs.SERVER_ID }} --output json)
          CLIENT_INFO=$(doctl compute droplet get ${{ steps.droplets.outputs.CLIENT_ID }} --output json)
          EXIT_INFO=$(doctl compute droplet get ${{ steps.droplets.outputs.EXIT_ID }} --output json)

          MASTER_IP=$(echo "$MASTER_INFO" | jq -r '.[0].networks.v4[] | select(.type=="private") | .ip_address')
          SERVER_IP=$(echo "$SERVER_INFO" | jq -r '.[0].networks.v4[] | select(.type=="private") | .ip_address')
          CLIENT_IP=$(echo "$CLIENT_INFO" | jq -r '.[0].networks.v4[] | select(.type=="private") | .ip_address')
          EXIT_IP=$(echo "$EXIT_INFO" | jq -r '.[0].networks.v4[] | select(.type=="private") | .ip_address')

          MASTER_PUBLIC=$(echo "$MASTER_INFO" | jq -r '.[0].networks.v4[] | select(.type=="public") | .ip_address')
          SERVER_PUBLIC=$(echo "$SERVER_INFO" | jq -r '.[0].networks.v4[] | select(.type=="public") | .ip_address')
          CLIENT_PUBLIC=$(echo "$CLIENT_INFO" | jq -r '.[0].networks.v4[] | select(.type=="public") | .ip_address')
          EXIT_PUBLIC=$(echo "$EXIT_INFO" | jq -r '.[0].networks.v4[] | select(.type=="public") | .ip_address')

          echo ""
          echo "════════════════════════════════════════════════════════════"
          echo "  RECORDING ENVIRONMENT READY"
          echo "════════════════════════════════════════════════════════════"
          echo ""
          echo "Session:  $SESSION_ID"
          echo "Project:  ${{ steps.project.outputs.PROJECT_ID }}"
          echo "VPC:      ${{ steps.vpc.outputs.VPC_ID }}"
          echo "Region:   ${{ env.DO_REGION }}"
          echo ""
          echo "────────────────────────────────────────────────────────────"
          echo "  DROPLET IP ADDRESSES"
          echo "────────────────────────────────────────────────────────────"
          echo ""
          printf "%-10s %-16s %-16s\n" "NAME" "PUBLIC" "PRIVATE"
          printf "%-10s %-16s %-16s\n" "master" "$MASTER_PUBLIC" "$MASTER_IP"
          printf "%-10s %-16s %-16s\n" "server" "$SERVER_PUBLIC" "$SERVER_IP"
          printf "%-10s %-16s %-16s\n" "client" "$CLIENT_PUBLIC" "$CLIENT_IP"
          printf "%-10s %-16s %-16s\n" "exit" "$EXIT_PUBLIC" "$EXIT_IP"
          echo ""
          echo "────────────────────────────────────────────────────────────"
          echo "  MASTER SETUP COMMAND"
          echo "────────────────────────────────────────────────────────────"
          echo ""
          echo "SSH into master and run:"
          echo "  ssh root@${MASTER_PUBLIC}"
          echo ""
          echo "Then execute:"
          echo "cat >> /etc/hosts << EOF"
          echo "${MASTER_IP} master"
          echo "${SERVER_IP} server"
          echo "${CLIENT_IP} client"
          echo "${EXIT_IP} exit"
          echo "EOF"
          echo ""
          echo "────────────────────────────────────────────────────────────"
          echo "  CLEANUP COMMANDS"
          echo "────────────────────────────────────────────────────────────"
          echo ""
          echo "# Delete all droplets:"
          echo "doctl compute droplet delete ${SESSION_ID}-master ${SESSION_ID}-server ${SESSION_ID}-client ${SESSION_ID}-exit --force"
          echo ""
          echo "# Delete VPC:"
          echo "doctl vpcs delete ${{ steps.vpc.outputs.VPC_ID }} --force"
          echo ""
          echo "# Delete project:"
          echo "doctl projects delete ${{ steps.project.outputs.PROJECT_ID }} --force"
          echo ""
          echo "════════════════════════════════════════════════════════════"